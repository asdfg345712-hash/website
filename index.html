<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>財富底氣戰情室 v41.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wealth: { bg: '#FDFBF7', text: '#2D3748', accent: '#F6AD55', green: '#68D391', pink: '#F687B3', blue: '#4A90E2', border: '#E2E8F0', dark: '#1A202C' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FDFBF7; color: #2D3748; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .card-shadow { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04); }
        .btn-active:active { transform: scale(0.96); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 指南裝飾樣式 */
        .manual-section { margin-bottom: 32px; }
        .logic-step { position: relative; padding-bottom: 24px; padding-left: 32px; border-left: 2px dashed #E2E8F0; }
        .logic-step::before { content: ''; position: absolute; left: -10px; top: 0; width: 18px; height: 18px; border-radius: 50%; background: #F6AD55; border: 3px solid white; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; color: white; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    </style>
</head>
<body class="antialiased pb-32 select-none">

    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- 頂部 Header -->
        <header class="sticky top-0 z-40 glass px-5 py-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-wealth-dark rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-chess-knight"></i>
                </div>
                <div>
                    <h1 class="text-sm font-black tracking-widest text-gray-800 uppercase">{{ currentYear }}年 {{ currentMonth }}月 戰情室</h1>
                    <div class="flex items-center gap-1">
                        <span class="text-[10px] bg-wealth-accent text-white px-1.5 py-0.5 rounded font-bold uppercase">LV.{{ stats.level }}</span>
                        <span class="text-[10px] text-gray-400 font-bold">{{ levelName }}</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <p class="text-[9px] text-wealth-pink font-black uppercase mb-0.5">信用卡專款隔離區</p>
                <p class="text-xl font-mono font-bold text-wealth-pink">NT$ {{ formatNumber(data.reservedCC) }}</p>
            </div>
        </header>

        <main class="flex-1 max-w-md mx-auto w-full px-4 py-6 space-y-8">

            <!-- 1. 當前戰略引導區 -->
            <section class="bg-white rounded-[2.5rem] p-6 border border-gray-100 card-shadow space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-sm font-black text-gray-700 flex items-center gap-2"><i class="fa-solid fa-compass text-wealth-accent"></i> 核心指令與診斷</h2>
                    <button @click="showSetup = true" class="text-[10px] bg-wealth-dark text-white px-4 py-2 rounded-full font-bold shadow-md btn-active">設定中心</button>
                </div>

                <div class="p-4 rounded-2xl border transition-all duration-500" :class="levelData.style">
                    <div class="flex items-center gap-3 mb-2">
                        <i :class="levelData.icon + ' text-xl'"></i>
                        <h3 class="text-sm font-black">{{ levelData.name }}階段：當前使命</h3>
                    </div>
                    <p class="text-[11px] font-bold leading-relaxed">{{ levelData.advice }}</p>
                </div>

                <!-- 關鍵進度條 -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <div class="bg-gray-50 p-3 rounded-2xl border border-gray-100">
                        <p class="text-[8px] font-black text-gray-400 uppercase">護城河目標進度</p>
                        <p class="text-xs font-mono font-black text-slate-700">{{ formatNumber(data.emergencyFund) }} / {{ formatNumber(data.moatTarget) }}</p>
                        <div class="w-full h-1 bg-gray-200 rounded-full mt-1.5 overflow-hidden">
                            <div class="h-full bg-wealth-accent transition-all duration-1000" :style="{width: Math.min(data.emergencyFund/data.moatTarget*100, 100)+'%'}"></div>
                        </div>
                    </div>
                    <div class="bg-orange-50/50 p-3 rounded-2xl border border-orange-100">
                        <p class="text-[8px] font-black text-wealth-accent uppercase">可用雜支袋餘額</p>
                        <p class="text-xs font-mono font-black text-wealth-text">NT$ {{ formatNumber(stats.remaining - data.reservedMisc) }}</p>
                        <p class="text-[8px] text-orange-400 font-bold mt-1 tracking-tighter">※ 分配後最終結餘本</p>
                    </div>
                </div>
            </section>

            <!-- 導航分頁 -->
            <div class="flex bg-gray-100/80 p-1.5 rounded-[1.5rem] border border-gray-200 shadow-inner overflow-x-auto no-scrollbar">
                <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                        class="flex-1 flex flex-col items-center justify-center gap-1 py-2.5 text-[10px] font-black rounded-xl transition-all min-w-[70px]"
                        :class="activeTab === tab.id ? 'bg-white shadow-md text-wealth-accent' : 'text-gray-400'">
                    <i :class="tab.icon"></i> {{ tab.name }}
                </button>
            </div>

            <!-- TAB: 指南手冊 (最完整解說版) -->
            <div v-if="activeTab === 'guide'" class="space-y-6 animate-in slide-in-from-bottom-4">
                <div class="bg-white rounded-[2.5rem] p-7 border border-gray-100 card-shadow space-y-8">
                    <h2 class="text-lg font-black text-wealth-dark text-center border-b pb-4 uppercase tracking-widest">
                        理財戰略作戰指南
                    </h2>

                    <!-- 1. 三個分級解說 -->
                    <div class="manual-section">
                        <h3 class="text-xs font-black text-wealth-accent border-l-4 border-wealth-accent pl-2 uppercase mb-4">財富分級系統定義</h3>
                        <div class="space-y-3">
                            <div class="p-3 bg-red-50 rounded-xl border border-red-100">
                                <p class="text-[11px] font-black text-red-700">Level 1：止血生存期</p>
                                <p class="text-[9px] text-red-600 leading-relaxed font-bold mt-1">
                                    當前狀態：存在利率大於 7% 的債務（如信用卡利息、民間信貸）。<br>
                                    戰略意義：此時「負債利息」會吃掉您的複利。首要任務是暫停所有投資與夢想預存袋，將所有餘額本全力投入本金還款。
                                </p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-xl border border-yellow-100">
                                <p class="text-[11px] font-black text-yellow-700">Level 2：護城河建築期</p>
                                <p class="text-[9px] text-yellow-600 leading-relaxed font-bold mt-1">
                                    當前狀態：無高利貸，但「緊急預備金」低於安全目標（建議 6 個月生活費）。<br>
                                    戰略意義：防禦是進攻的前提。此階段應減少雜支分配，將資源優先投入填補預備金，建立心理底氣。
                                </p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl border border-green-100">
                                <p class="text-[11px] font-black text-green-700">Level 3：資產擴張期</p>
                                <p class="text-[9px] text-green-600 leading-relaxed font-bold mt-1">
                                    當前狀態：債務清零、預備金充足、財務體質極佳。<br>
                                    戰略意義：全面執行 532 分配。啟動 30% 定期定額投資與 20% 預存袋分配，讓資產隨複利滾動成長。
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 兩條路徑解說 -->
                    <div class="manual-section pt-4 border-t border-dashed">
                        <h3 class="text-xs font-black text-wealth-dark uppercase border-l-4 border-wealth-dark pl-2 mb-4">兩大分配路徑說明</h3>
                        <div class="pl-1 space-y-4">
                            <div class="logic-step">
                                <p class="text-[11px] font-black">路徑 A：有負債流程 (止血優先)</p>
                                <p class="text-[9px] text-gray-400 font-bold leading-relaxed">
                                    順序：固定支出 → 清償債務 → 生活費 → 雜支。<br>
                                    意義：強行截斷利息侵蝕，用最短時間奪回財務主控權。
                                </p>
                            </div>
                            <div class="logic-step" style="border-left-color: transparent; padding-bottom: 0;">
                                <p class="text-[11px] font-black">路徑 B：無負債流程 (成長優先)</p>
                                <p class="text-[9px] text-gray-400 font-bold leading-relaxed">
                                    順序：固定支出 → 資產投資 → 預存準備 → 生活費 → 雜支。<br>
                                    意義：在花錢前先支付給未來的自己，落實不記帳也能存錢的零基系統。
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 操作功能教學 -->
                    <div class="manual-section pt-4 border-t border-dashed">
                        <h3 class="text-xs font-black text-wealth-blue border-l-4 border-wealth-blue pl-2 uppercase mb-4">系統功能操作說明</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="bg-gray-50 p-4 rounded-2xl">
                                <p class="text-[10px] font-black flex items-center gap-2"><i class="fa-solid fa-credit-card text-wealth-pink"></i> 刷卡同步的意義與方法</p>
                                <p class="text-[9px] text-gray-400 leading-relaxed font-bold mt-1">
                                    每當刷卡後，從對應執行袋點擊「同步」。系統會將虛擬現金從袋子移至「信用卡隔離區」。這確保結帳日當天，您的銀行帳戶內已有專屬還款金，不需動用當月生活費。
                                </p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-2xl">
                                <p class="text-[10px] font-black flex items-center gap-2"><i class="fa-solid fa-envelope-open-text text-wealth-blue"></i> 五週現金袋的意義</p>
                                <p class="text-[9px] text-gray-400 leading-relaxed font-bold mt-1">
                                    每月按週領取。多領一週是為了緩衝月份天數差。領完後這週不再記帳，只需管好手中剩多少錢。花完就代表這週餐費超支。
                                </p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-2xl">
                                <p class="text-[10px] font-black flex items-center gap-2"><i class="fa-solid fa-hourglass-half text-wealth-dark"></i> 生命工時拷問的意義</p>
                                <p class="text-[9px] text-gray-400 leading-relaxed font-bold mt-1">
                                    系統會依您的月薪換算時薪。購物前輸入價格，系統會告訴您這件物品價值您生命中多少小時。這能有效壓抑不理性的購物慾望。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: 領取信封 -->
            <div v-if="activeTab === 'budget'" class="space-y-6 animate-in fade-in">
                <section class="space-y-3">
                    <div class="flex justify-between items-center px-1">
                        <h2 class="text-sm font-black text-gray-600 flex items-center gap-2"><i class="fa-solid fa-calendar-day text-wealth-accent"></i> 餐費週預算分裝袋</h2>
                        <span class="text-[10px] font-black text-white bg-wealth-accent px-2 py-1 rounded-lg">週領 NT$ {{ formatNumber(weeklyFood) }}</span>
                    </div>
                    <div class="space-y-2">
                        <button v-for="(date, i) in currentMonthWeeks" :key="i" @click="toggleWeek(i)" 
                                class="w-full flex justify-between items-center p-4 rounded-[1.8rem] border-2 transition-all btn-active"
                                :class="data.paidWeeks.includes(i) ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-wealth-accent/30 shadow-sm'">
                            <div class="text-left"><p class="text-[10px] font-mono font-black opacity-30">{{ date }}</p><p class="text-xs font-bold text-slate-700">第 {{ i+1 }} 週執行現金</p></div>
                            <span v-if="data.paidWeeks.includes(i)" class="text-[10px] font-bold text-gray-400"><i class="fa-solid fa-check"></i> 已領取</span>
                            <span v-else class="text-[10px] font-bold text-wealth-accent bg-orange-50 px-3 py-1.5 rounded-full border border-orange-100">點擊領取</span>
                        </button>
                    </div>
                </section>
                
                <section class="grid grid-cols-2 gap-3 pt-4 border-t border-dashed border-gray-200">
                    <div v-for="bag in ['transportTotal', 'householdTotal']" :key="bag" class="bg-white p-4 rounded-[2.2rem] border border-gray-100 card-shadow">
                        <p class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">{{ getBagLabel(bag) }}袋</p>
                        <p class="text-lg font-mono font-bold text-gray-700 mt-1">NT$ {{ formatNumber(data[bag]) }}</p>
                        <button @click="openModal('swipe', bag, getBagLabel(bag))" class="mt-3 w-full py-2.5 text-[10px] bg-wealth-dark text-white rounded-xl font-bold btn-active">刷卡同步</button>
                    </div>
                    <div class="bg-white p-5 rounded-[2.2rem] border-2 border-wealth-accent/20 bg-orange-50/10 card-shadow col-span-2 flex items-center justify-between">
                        <div><p class="text-[9px] font-black text-wealth-accent uppercase">個人雜支袋 (月底餘額本)</p><p class="text-xl font-mono font-bold text-gray-800">NT$ {{ formatNumber(stats.remaining - data.reservedMisc) }}</p></div>
                        <button @click="openModal('swipeMisc', 'reservedMisc', '雜支消費')" class="py-2.5 px-6 text-[10px] bg-wealth-accent text-white rounded-2xl font-black btn-active">同步刷卡</button>
                    </div>
                </section>
            </div>

            <!-- TAB: 拷問挑戰 -->
            <div v-if="activeTab === 'challenge'" class="space-y-8 animate-in zoom-in-95">
                <section class="bg-wealth-dark rounded-[2.5rem] p-8 text-white relative overflow-hidden shadow-2xl">
                    <h2 class="text-sm font-black mb-6 text-wealth-accent flex items-center gap-2 tracking-widest"><i class="fa-solid fa-hourglass-half"></i> 生命工時拷問機</h2>
                    <div class="space-y-6 relative z-10">
                        <div class="relative">
                            <span class="absolute left-0 bottom-2 text-gray-500 font-mono text-xl uppercase">NT$</span>
                            <input type="number" v-model.number="soulPrice" placeholder="想買什麼？輸入價格..." class="w-full bg-transparent border-b-2 border-gray-700 pl-10 pb-2 text-3xl font-mono font-black focus:border-wealth-accent outline-none" />
                        </div>
                        <div v-if="soulPrice > 0" class="flex items-center justify-between bg-gray-800/50 p-5 rounded-2xl border border-gray-700">
                            <div><p class="text-[9px] text-gray-400 font-black">代價生命時間</p><p class="text-4xl font-black text-wealth-accent mt-1">{{ (soulPrice / (data.salary / 160)).toFixed(1) }} <span class="text-xs font-sans opacity-40 uppercase">Hours</span></p></div>
                            <div class="text-right">
                                <p class="text-[10px] font-black px-4 py-2 rounded-full border shadow-inner" :class="soulPrice <= (stats.remaining - data.reservedMisc) ? 'border-green-500 text-green-500' : 'border-red-500 text-red-500'">
                                    {{ soulPrice <= (stats.remaining - data.reservedMisc) ? '雜支足以支付' : '餘額不足建議停止' }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white/5 rounded-full blur-3xl"></div>
                </section>

                <section class="bg-white rounded-[2.5rem] p-6 border border-gray-100 card-shadow space-y-4">
                    <div class="flex justify-between items-end px-1">
                        <div><p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">存量階段：{{ stats.currentStage }} / 5</p><h3 class="text-lg font-black text-wealth-dark uppercase tracking-widest">小花存錢挑戰</h3></div>
                        <div class="text-right"><p class="text-[10px] text-wealth-pink font-bold">每朵花 ${{ formatNumber(data.challengeConfig.flowerValue) }}</p><span class="text-xs font-mono font-black text-wealth-pink">{{ stats.doneInStage }}/20</span></div>
                    </div>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button v-for="n in 20" :key="n" @click="toggleFlower(n)" 
                                class="w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 btn-active shadow-sm"
                                :class="isFlowerDoneInStage(n) ? 'bg-wealth-pink text-white scale-110 shadow-lg' : 'bg-gray-100 text-gray-300 hover:bg-rose-50'">
                            <i class="fa-solid fa-heart text-xs"></i>
                        </button>
                    </div>
                </section>
            </div>

            <!-- TAB: 預存袋 -->
            <div v-if="activeTab === 'sinking'" class="space-y-6">
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(fund, index) in data.sinkingFunds" :key="fund.id" @click="openModal('deposit', index, fund.name)"
                         class="bg-white p-4 rounded-[2.2rem] border border-gray-100 card-shadow h-32 flex flex-col justify-between relative overflow-hidden btn-active transition-all group hover:border-wealth-accent">
                        <div class="flex justify-between items-start z-10"><div class="p-2 bg-gray-50 rounded-xl text-gray-400 group-hover:text-wealth-accent transition-colors"><i :class="'fa-solid fa-' + getIcon(fund.icon)"></i></div><span class="text-[8px] font-black text-wealth-accent bg-orange-50 px-1 rounded">{{ Math.round((fund.current/fund.target)*100) || 0 }}%</span></div>
                        <div class="z-10"><p class="text-[9px] font-black text-gray-400 truncate uppercase tracking-widest">{{ fund.name }}</p><p class="text-sm font-mono font-bold text-gray-700">NT$ {{ formatNumber(fund.current) }}</p></div>
                        <div class="absolute bottom-0 left-0 w-full h-1 bg-gray-50"><div class="h-full bg-wealth-accent transition-all duration-1000" :style="{ width: `${Math.min((fund.current/fund.target)*100, 100)}%` }"></div></div>
                    </div>
                </div>
            </div>

            <!-- TAB: 旅遊精算 -->
            <div v-if="activeTab === 'travel'" class="space-y-6 animate-in slide-in-from-bottom-4">
                <section class="bg-blue-500 rounded-[3rem] p-8 text-white relative overflow-hidden shadow-xl" style="background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%)">
                    <i class="fa-solid fa-plane-departure absolute -top-4 -right-4 text-9xl opacity-20 rotate-12"></i>
                    <h2 class="text-sm font-black mb-8 border-b border-white/20 pb-2 uppercase tracking-widest flex items-center gap-2">出國預算精算</h2>
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-white/10 p-4 rounded-3xl border border-white/10 shadow-inner">
                                <p class="text-[9px] text-blue-100 font-bold uppercase mb-1">總預算目標</p>
                                <p class="text-lg font-mono font-bold">NT$ {{ formatNumber(data.travel.total) }}</p>
                            </div>
                            <div class="bg-white/10 p-4 rounded-3xl border border-white/10 shadow-inner">
                                <p class="text-[9px] text-rose-100 font-bold uppercase mb-1">機加酒預扣</p>
                                <p class="text-lg font-mono font-bold">NT$ {{ formatNumber(data.travel.fixed) }}</p>
                            </div>
                        </div>
                        <div class="bg-white/20 rounded-[2.5rem] p-8 text-center shadow-lg border border-white/20 backdrop-blur-sm">
                            <p class="text-[10px] text-white font-black uppercase tracking-[0.2em] mb-2">每日餐費上限 ({{ data.travel.days }}天)</p>
                            <p class="text-4xl font-mono font-bold drop-shadow-md tracking-tighter">NT$ {{ formatNumber(Math.floor((data.travel.total - data.travel.fixed - data.travel.gifts) / data.travel.days)) }}</p>
                        </div>
                    </div>
                </section>
                <div class="text-center p-4">
                    <button @click="showSetup = true" class="text-[10px] text-wealth-blue font-black flex items-center gap-2 mx-auto uppercase underline underline-offset-4"><i class="fa-solid fa-sliders"></i> 到設定頁調整旅遊預算與參數</button>
                </div>
            </div>

        </main>

        <!-- 底部導航 -->
        <nav class="fixed bottom-0 left-0 right-0 h-24 glass flex items-center justify-around z-50 px-2 shadow-2xl border-t overflow-x-auto no-scrollbar">
            <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                    class="flex flex-col items-center gap-1.5 transition-all w-16 shrink-0"
                    :class="activeTab === tab.id ? 'text-wealth-accent scale-110' : 'text-gray-300 opacity-60'">
                <div class="p-2.5 rounded-2xl" :class="activeTab === tab.id ? 'bg-orange-50' : 'bg-transparent'"><i :class="tab.icon + ' text-lg'"></i></div>
                <span class="text-[9px] font-black uppercase tracking-tighter">{{ tab.name }}</span>
            </button>
        </nav>

        <!-- 指令設定中心 -->
        <transition name="slide-up">
            <div v-if="showSetup" class="fixed inset-0 z-[100] flex flex-col justify-end">
                <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" @click="showSetup = false"></div>
                <div class="relative bg-white w-full max-w-md mx-auto rounded-t-[3.5rem] p-8 shadow-2xl max-h-[95vh] overflow-y-auto no-scrollbar">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-8"></div>
                    <h2 class="text-xl font-black text-center mb-8 uppercase tracking-widest text-gray-800 underline underline-offset-8 decoration-wealth-accent">戰略設定指揮部</h2>
                    
                    <div class="space-y-8 pb-10">
                        <!-- 第一順位：收入與預備金 -->
                        <section class="space-y-4">
                            <div class="flex justify-between items-center">
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">STEP 1. 流動資金源與目標</p>
                                <button @click="autoApplyStrategy" class="text-[9px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-xl font-black border border-emerald-100 flex items-center gap-1 shadow-sm"><i class="fa-solid fa-wand-magic-sparkles"></i> 建議分配比例</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[9px] font-bold text-gray-400 uppercase">主要薪資</label><input type="number" v-model.number="data.salary" class="w-full border-b py-2 font-mono text-sm bg-transparent outline-none focus:border-wealth-accent"></div>
                                <div><label class="text-[9px] font-bold text-emerald-500 uppercase">額外獎金</label><input type="number" v-model.number="data.extraIncome" class="w-full border-b py-2 font-mono text-sm bg-transparent outline-none border-emerald-100 text-emerald-600"></div>
                                <div class="col-span-2 bg-yellow-50 p-4 rounded-2xl border border-yellow-100">
                                    <label class="text-[9px] font-black text-yellow-600 uppercase">護城河安全水位 / 現有存款</label>
                                    <div class="grid grid-cols-2 gap-4 mt-1">
                                        <input type="number" v-model.number="data.emergencyFund" class="w-full border-b border-yellow-200 py-1 font-mono text-sm bg-transparent outline-none text-yellow-700" placeholder="現有存款">
                                        <input type="number" v-model.number="data.moatTarget" class="w-full border-b border-yellow-200 py-1 font-mono text-sm bg-transparent outline-none text-yellow-700" placeholder="目標存款">
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- 第二順位：固定支出細項 (核心需求：房租、貸款等) -->
                        <section class="space-y-4 bg-gray-50 p-5 rounded-[2rem] border border-gray-200 shadow-inner">
                            <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest px-1">STEP 2. 固定必要支出編輯</p>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-4">
                                <div v-for="(val, key) in data.fixedExpenses" :key="key">
                                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">{{ getFixedLabel(key) }}</label>
                                    <div class="flex items-center gap-1 border-b py-1 border-gray-200">
                                        <span class="text-[10px] text-gray-400 font-bold">NT$</span>
                                        <input type="number" v-model.number="data.fixedExpenses[key]" class="w-full text-right outline-none font-mono text-xs bg-transparent font-black">
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- 第三順位：負債管理 -->
                        <section class="space-y-4 bg-red-50/50 p-5 rounded-[2rem] border border-red-100/50">
                            <p class="text-[10px] font-black text-red-600 uppercase">STEP 3. 債務止血監測</p>
                            <div class="grid grid-cols-2 gap-3 mb-2">
                                <input type="text" v-model="newDebt.name" placeholder="債務名稱" class="text-[11px] p-2.5 border rounded-xl shadow-sm outline-none">
                                <input type="number" v-model.number="newDebt.balance" placeholder="本金餘額" class="text-[11px] p-2.5 border rounded-xl shadow-sm outline-none">
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <input type="number" v-model.number="newDebt.rate" placeholder="利率%" class="text-[11px] p-2.5 border rounded-xl outline-none">
                                <input type="number" v-model.number="newDebt.monthly" placeholder="月繳額" class="text-[11px] p-2.5 border rounded-xl outline-none">
                                <button @click="handleAddDebt" class="bg-red-500 text-white rounded-xl text-[11px] font-black btn-active shadow-lg">新增債務</button>
                            </div>
                            <div v-for="d in data.debts" :key="d.id" class="flex justify-between items-center bg-white p-3 rounded-2xl border shadow-sm mt-2">
                                <div><p class="text-[10px] font-bold text-gray-700">{{ d.name }} ({{ d.rate }}%)</p></div>
                                <div class="flex items-center gap-3"><p class="text-[10px] font-mono font-bold text-red-500">-${{ formatNumber(d.monthly) }}</p><i class="fa-solid fa-trash-can text-gray-300 btn-active" @click="removeDebt(d.id)"></i></div>
                            </div>
                        </section>

                        <!-- 第四順位：零基分配與連動編輯 -->
                        <section class="space-y-4">
                            <div class="flex justify-between items-center px-1">
                                <p class="text-[10px] font-black text-wealth-blue uppercase tracking-widest">STEP 4. 預算分裝與編輯</p>
                                <div class="text-[10px] font-black" :class="stats.remaining < 0 ? 'text-red-500' : 'text-emerald-500'">餘額剩：NT$ {{ formatNumber(stats.remaining) }}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                                    <label class="text-[9px] font-bold text-emerald-700 uppercase">定投投資額</label>
                                    <input type="number" v-model.number="data.investMonthly" class="w-full border-b border-emerald-200 py-1 font-mono text-sm outline-none bg-transparent font-bold">
                                </div>
                                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                                    <label class="text-[9px] font-bold text-emerald-700 uppercase">預存袋撥款</label>
                                    <input type="number" v-model.number="data.sinkingMonthly" class="w-full border-b border-emerald-200 py-1 font-mono text-sm outline-none bg-transparent font-bold">
                                </div>
                                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                    <label class="text-[9px] font-bold text-blue-700 uppercase">週餐費設定</label>
                                    <input type="number" v-model.number="inputWeeklyFood" @input="updateFoodFromWeekly" class="w-full border-b border-blue-200 py-1 font-mono text-sm outline-none bg-transparent font-bold">
                                </div>
                                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                    <label class="text-[9px] font-bold text-blue-700 uppercase">雜支/餘額袋</label>
                                    <input type="number" v-model.number="data.miscTarget" class="w-full border-b border-blue-200 py-1 font-mono text-sm outline-none bg-transparent font-bold">
                                </div>
                                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                    <label class="text-[9px] font-bold text-blue-700 uppercase">交通加油包</label>
                                    <input type="number" v-model.number="data.transportTotal" class="w-full border-b border-blue-200 py-1 font-mono text-sm outline-none bg-transparent font-bold">
                                </div>
                                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                    <label class="text-[9px] font-bold text-blue-700 uppercase">日用家事包</label>
                                    <input type="number" v-model.number="data.householdTotal" class="w-full border-b border-blue-200 py-1 font-mono text-sm outline-none bg-transparent font-bold">
                                </div>
                            </div>
                        </section>

                        <!-- 第五順位：子系統目標 -->
                        <section class="space-y-4">
                            <p class="text-[10px] font-black text-gray-400 uppercase px-1">STEP 5. 專項與預存袋目標設定</p>
                            <div class="grid grid-cols-2 gap-4 bg-gray-50 p-5 rounded-[2rem] border border-gray-200">
                                <div class="col-span-2 grid grid-cols-3 gap-2 pb-3 border-b mb-2">
                                    <div><label class="text-[8px] text-gray-500 uppercase">小花單價</label><input type="number" v-model.number="data.challengeConfig.flowerValue" class="w-full border-b py-1 font-mono text-xs"></div>
                                    <div><label class="text-[8px] text-gray-500 uppercase">旅遊預算</label><input type="number" v-model.number="data.travel.total" class="w-full border-b py-1 font-mono text-xs"></div>
                                    <div><label class="text-[8px] text-gray-500 uppercase">旅遊天數</label><input type="number" v-model.number="data.travel.days" class="w-full border-b py-1 font-mono text-xs"></div>
                                </div>
                                <div v-for="fund in data.sinkingFunds" :key="fund.id" class="space-y-1">
                                    <label class="text-[9px] font-black text-gray-400 truncate block">{{ fund.name }}目標</label>
                                    <input type="number" v-model.number="fund.target" class="w-full border-b py-1 font-mono text-xs outline-none bg-transparent font-bold">
                                </div>
                            </div>
                        </section>

                        <button @click="showSetup = false" 
                                :disabled="stats.remaining < 0"
                                class="w-full py-5 bg-wealth-dark text-white rounded-[2.5rem] font-black shadow-xl btn-active tracking-widest uppercase disabled:opacity-50">
                            {{ stats.remaining < 0 ? '預算透支請重新調整' : '同步指令並啟動戰情室' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 通用輸入 Modal -->
        <transition name="fade">
            <div v-if="modal.show" class="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-gray-900/60 backdrop-blur-sm">
                <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl space-y-6">
                    <h3 class="text-center font-black text-lg text-gray-700">{{ modal.title }}</h3>
                    <div class="bg-gray-50 p-4 rounded-2xl flex items-center justify-center border border-gray-100">
                        <span class="text-2xl font-bold text-gray-400 mr-2">NT$</span>
                        <input type="number" v-model="inputValue" autoFocus class="bg-transparent text-4xl font-mono font-bold text-gray-800 outline-none w-40 text-center" placeholder="0" />
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="modal.show = false" class="py-4 rounded-2xl font-bold text-gray-400 bg-gray-100 uppercase tracking-widest text-[11px]">取消</button>
                        <button @click="handleModalSubmit" class="py-4 rounded-2xl font-bold text-white bg-wealth-dark shadow-lg btn-active uppercase text-[11px]">確定同步</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, reactive, computed, watch } = Vue;

        createApp({
            setup() {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                const getMonthWeeks = (y, m) => {
                    const weeks = [];
                    const start = new Date(y, m-1, 1);
                    const end = new Date(y, m, 0);
                    let curr = new Date(start);
                    while(curr <= end) {
                        let ws = new Date(curr);
                        let we = new Date(curr);
                        we.setDate(ws.getDate() + 6);
                        if (we > end) we = end;
                        weeks.push(`${ws.getMonth()+1}/${ws.getDate()} - ${we.getMonth()+1}/${we.getDate()}`);
                        curr.setDate(curr.getDate() + 7);
                    }
                    return weeks;
                };
                const foodWeeks = getMonthWeeks(currentYear, currentMonth);

                const defaultData = {
                    salary: 45600, extraIncome: 0,
                    fixedExpenses: { loan: 3500, rent: 12000, phone: 699, utility: 1500, other: 0 },
                    debts: [], investMonthly: 10000, sinkingMonthly: 5000, emergencyFund: 15000, moatTarget: 120000,
                    foodTotal: 12500, transportTotal: 2000, householdTotal: 5000, miscTarget: 2500,
                    challengeConfig: { flowerValue: 400 },
                    flowers: Array(100).fill(false),
                    sinkingFunds: [
                        { id: 1, name: '年度稅金', target: 12000, current: 0, icon: 'calendar-days' },
                        { id: 2, name: '定期保費', target: 20000, current: 0, icon: 'heart-pulse' },
                        { id: 3, name: '出國計畫', target: 100000, current: 0, icon: 'plane' },
                        { id: 4, name: '緩衝備用', target: 50000, current: 0, icon: 'money-bill-wave' },
                        { id: 5, name: '購物清單', target: 10000, current: 0, icon: 'bag-shopping' },
                        { id: 6, name: '社交活動', target: 10000, current: 0, icon: 'users' },
                        { id: 7, name: '自定義A', target: 5000, current: 0, icon: 'plus' },
                        { id: 8, name: '自定義B', target: 5000, current: 0, icon: 'tag' }
                    ],
                    paidWeeks: [], reservedCC: 0, reservedMisc: 0,
                    travel: { total: 50000, fixed: 25000, gifts: 5000, days: 5 }
                };

                const data = reactive(JSON.parse(localStorage.getItem('wealth_v41_data')) || defaultData);
                const inputWeeklyFood = ref(Math.floor(data.foodTotal / foodWeeks.length));
                watch(data, (v) => localStorage.setItem('wealth_v41_data', JSON.stringify(v)), { deep: true });

                const activeTab = ref('budget');
                const showSetup = ref(false);
                const soulPrice = ref(null);
                const inputValue = ref('');
                const newDebt = reactive({ name: '', balance: null, rate: null, monthly: null });
                const modal = reactive({ show: false, type: '', key: '', title: '', index: -1 });

                const tabs = [
                    { id: 'guide', name: '戰略指南', icon: 'fa-solid fa-book-open' },
                    { id: 'budget', name: '執行袋', icon: 'fa-solid fa-envelope-open-text' },
                    { id: 'challenge', name: '拷問挑戰', icon: 'fa-solid fa-heart' },
                    { id: 'sinking', name: '預存袋', icon: 'fa-solid fa-piggy-bank' },
                    { id: 'travel', name: '旅遊精算', icon: 'fa-solid fa-plane-departure' }
                ];

                const stats = computed(() => {
                    const income = Number(data.salary) + Number(data.extraIncome);
                    const debtMonthly = data.debts.reduce((a, b) => a + Number(b.monthly), 0);
                    const fixedTotal = Object.values(data.fixedExpenses).reduce((a, b) => a + Number(b), 0);
                    const totalFixed = fixedTotal + debtMonthly;
                    const prioritySavings = Number(data.investMonthly) + Number(data.sinkingMonthly);
                    const livingNecessary = Number(data.foodTotal) + Number(data.transportTotal) + Number(data.householdTotal);
                    const remaining = income - totalFixed - prioritySavings - livingNecessary;

                    const doneCount = data.flowers.filter(f => f).length;
                    let level = 3;
                    const hasHighDebt = data.debts.some(d => Number(d.rate) > 7);
                    if (hasHighDebt) level = 1; else if (data.emergencyFund < data.moatTarget) level = 2;

                    return { income, totalFixed, prioritySavings, livingNecessary, remaining, level, hasHighDebt, 
                             currentStage: Math.floor(doneCount / 20) + 1, doneInStage: doneCount % 20 };
                });

                const levelName = computed(() => ['止血期','護城河期','成長期'][stats.value.level-1]);
                const levelData = computed(() => {
                    const lv = stats.value.level;
                    if (lv === 1) return { name: '止血', advice: '偵測到高利貸。戰略：停止投資，將每月 '+formatNumber(data.investMonthly+data.sinkingMonthly)+' 元預算改為優先還債。', icon: 'fa-solid fa-kit-medical', style: 'bg-red-50 border-red-200 text-red-700' };
                    if (lv === 2) return { name: '防禦', advice: '存款低於護城河目標。目標：NT$ '+formatNumber(data.moatTarget)+'。建議減少非必要雜支。', icon: 'fa-solid fa-shield-halved', style: 'bg-yellow-50 border-yellow-200 text-yellow-800' };
                    return { name: '擴張', advice: '財務體質健康。當前路徑：落實 532 分配，穩定進行資產定期投資，享受複利。', icon: 'fa-solid fa-chart-line', style: 'bg-green-50 border-green-200 text-green-800' };
                });

                const autoApplyStrategy = () => {
                    const surplus = stats.value.income - stats.value.totalFixed;
                    if (surplus <= 0) return alert("薪資不足以支付固定費，請檢視固定支出！");
                    if (stats.value.hasHighDebt) { data.investMonthly = 0; data.sinkingMonthly = 0; }
                    else { data.investMonthly = Math.floor(surplus * 0.3); data.sinkingMonthly = Math.floor(surplus * 0.2); }
                    const left = surplus - data.investMonthly - data.sinkingMonthly;
                    data.foodTotal = Math.floor(left * 0.6);
                    inputWeeklyFood.value = Math.floor(data.foodTotal / foodWeeks.length);
                    data.transportTotal = Math.floor(left * 0.1); data.householdTotal = Math.floor(left * 0.1); data.miscTarget = Math.floor(left * 0.2);
                };

                const updateFoodFromWeekly = () => { data.foodTotal = inputWeeklyFood.value * foodWeeks.length; };
                const formatNumber = (n) => Math.round(n || 0).toLocaleString();
                const getFixedLabel = (k) => ({ loan: '學貸/貸款', rent: '房租/房貸', phone: '電信通訊', utility: '水電瓦斯', other: '自訂其他' }[k]);
                const getBagLabel = (k) => ({ householdTotal: '家用', transportTotal: '交通' }[k]);
                const getIcon = (n) => ({ 'calendar-days': 'calendar-days', 'heart-pulse': 'heart-pulse', 'plane': 'plane', 'money-bill-wave': 'money-bill-wave', 'bag-shopping': 'bag-shopping', 'users': 'users', 'tag': 'tag', 'plus': 'plus' }[n] || 'circle');

                const toggleWeek = (i) => { const idx = data.paidWeeks.indexOf(i); if (idx === -1) data.paidWeeks.push(i); else data.paidWeeks.splice(idx, 1); };
                const isFlowerDoneInStage = (n) => data.flowers[(stats.value.currentStage - 1) * 20 + (n - 1)];
                const toggleFlower = (n) => { const idx = (stats.value.currentStage - 1) * 20 + (n - 1); data.flowers[idx] = !data.flowers[idx]; };

                const openModal = (type, key, title, index = -1) => { modal.show = true; modal.type = type; modal.key = key; modal.title = title; modal.index = index; inputValue.value = ''; };
                const handleModalSubmit = () => {
                    const v = parseInt(inputValue.value); if (!v || v <= 0) return;
                    if (modal.type === 'swipe') { data[modal.key] -= v; data.reservedCC += v; }
                    else if (modal.type === 'swipeMisc') { data.reservedCC += v; data.reservedMisc += v; }
                    else if (modal.type === 'deposit') { data.sinkingFunds[modal.index].current += v; }
                    modal.show = false;
                };

                const handleAddDebt = () => { if(!newDebt.name || !newDebt.balance) return; data.debts.push({ id: Date.now(), name: newDebt.name, balance: Number(newDebt.balance), rate: Number(newDebt.rate), monthly: Number(newDebt.monthly) }); newDebt.name = ''; newDebt.balance = null; newDebt.rate = null; newDebt.monthly = null; };
                const removeDebt = (id) => data.debts = data.debts.filter(d => d.id !== id);

                return { currentYear, currentMonth, currentMonthWeeks: foodWeeks, data, stats, activeTab, showSetup, levelData, soulPrice, modal, inputValue, inputWeeklyFood, newDebt, tabs, formatNumber, getFixedLabel, getBagLabel, getIcon, toggleWeek, isFlowerDoneInStage, toggleFlower, openModal, handleModalSubmit, handleAddDebt, removeDebt, weeklyFood: computed(()=>Math.floor(data.foodTotal/foodWeeks.length)), autoApplyStrategy, updateFoodFromWeekly, levelName: computed(()=>levelData.value.name) };
            }
        }).mount('#app');
    </script>
</body>
</html>