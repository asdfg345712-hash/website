<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æŒ‡æ®å®˜ | æˆ°ç•¥ç†è²¡ç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Lucide åœ–ç¤º -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        
        :root {
            --slate-bg: #71767C;
        }

        body {
            background-color: var(--slate-bg);
            font-family: 'Noto Sans TC', sans-serif;
            color: #1F2937;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        /* æ¨¡æ“¬æ‰‹æ©Ÿå®¹å™¨ */
        .app-shell {
            width: 100%;
            max-width: 480px;
            background-color: #FFFFFF;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow-x: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* è¼¸å…¥æ¡†æ¨£å¼é‚„åŸåœ–ç‰‡é¢¨æ ¼ */
        .input-underline {
            border-bottom: 2px solid #E5E7EB;
            width: 100%;
            padding: 8px 4px;
            font-weight: 800;
            outline: none;
            transition: all 0.3s;
            background: transparent;
        }
        .input-underline:focus {
            border-color: #3B82F6;
            background-color: #F9FAFB;
        }

        .step-card {
            background: #FFFFFF;
            border-radius: 40px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #F3F4F6;
        }

        .gray-card {
            background: #F9FAFB;
            border-radius: 40px;
            padding: 24px;
        }

        .waterfall-step::after {
            content: "â†“";
            display: block;
            text-align: center;
            color: #D1D5DB;
            font-size: 1.5rem;
            margin: 8px 0;
        }
        .waterfall-step:last-child::after { content: ""; }

        .btn-sync {
            background: #111827;
            color: white;
            width: 100%;
            padding: 18px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1.1rem;
            letter-spacing: 1px;
            transition: transform 0.2s;
        }
        .btn-sync:active { transform: scale(0.97); }

        .toggle-btn {
            @apply flex-1 py-2 text-[10px] font-black rounded-xl transition-all;
        }

        .msg-box {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 700;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="app" class="app-shell no-scrollbar">
    
    <!-- æç¤ºæ¡† -->
    <div v-if="message" class="msg-box animate-bounce">{{ message }}</div>

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="p-6 pb-2 sticky top-0 bg-white/90 backdrop-blur-md z-50 border-b border-gray-50 flex justify-between items-center">
        <i data-lucide="chevron-down" class="w-6 h-6 text-gray-800"></i>
        <div class="text-center">
            <h1 class="font-black text-lg tracking-tighter">è³‡ç”¢æŒ‡æ®å®˜</h1>
            <p class="text-[9px] text-gray-400 font-mono uppercase">Strategic Finance v3.2</p>
        </div>
        <div class="flex items-center gap-3">
            <button @click="exportCSV" class="p-1 text-gray-400"><i data-lucide="download" class="w-5 h-5"></i></button>
            <i data-lucide="x" class="w-6 h-6 text-gray-800"></i>
        </div>
    </header>

    <!-- ä¸»åˆ†é å°è¦½ -->
    <nav class="flex justify-around bg-white px-6 py-2 sticky top-[72px] z-40 border-b border-gray-50 text-[10px] font-black text-gray-400 uppercase tracking-widest">
        <button v-for="t in tabs" :key="t.id" @click="currentTab = t.id" :class="{'text-gray-900 border-b-2 border-gray-900': currentTab === t.id}" class="pb-2 px-1 transition-all">
            {{ t.name }}
        </button>
    </nav>

    <main class="p-6 flex-1 overflow-y-auto no-scrollbar space-y-10 pb-24">
        
        <!-- SETUP: æˆ°ç•¥æŒ‡ä»¤è¨­å®š -->
        <div v-if="currentTab === 'setup'" class="animate-in fade-in duration-500 space-y-10">
            
            <div class="flex justify-between items-start">
                <h2 class="text-3xl font-black flex items-center gap-3">
                    <span class="w-2.5 h-8 bg-orange-400 rounded-full shadow-sm"></span>
                    æˆ°ç•¥æŒ‡ä»¤
                </h2>
                <button @click="confirmRollover" class="bg-blue-500 text-white text-[9px] font-black px-4 py-2 rounded-xl flex items-center gap-2 shadow-lg active:scale-95">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> é–‹å•Ÿæ–°æœˆçµè½‰
                </button>
            </div>

            <!-- STEP 1: æµå‹•è³‡ç”¢ -->
            <section>
                <div class="flex justify-between items-center mb-6">
                    <p class="text-[10px] font-black text-gray-300 uppercase tracking-widest">Step 1. æµå‹•è³‡ç”¢èˆ‡ç›®æ¨™</p>
                    <button @click="applyDefaultAllocation" class="bg-emerald-50 text-emerald-600 text-[10px] font-black px-3 py-1.5 rounded-full border border-emerald-100 flex items-center gap-1 active:bg-emerald-100">
                        <i data-lucide="calculator" class="w-3 h-3"></i> æˆ°è¡“å»ºè­°æ¯”ä¾‹
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-8 mb-6">
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase block mb-1">ä¸»è¦è–ªè³‡</label>
                        <input type="number" v-model.number="config.salary" class="input-underline text-xl font-black">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-emerald-400 uppercase block mb-1">é¡å¤–çé‡‘</label>
                        <input type="number" v-model.number="config.bonus" class="input-underline text-xl font-black text-emerald-600">
                    </div>
                </div>

                <div class="step-card bg-amber-50/50 border-amber-100">
                    <label class="text-[10px] font-black text-orange-400 block mb-3 uppercase tracking-tighter">è­·åŸæ²³ç›®æ¨™æ°´ä½ / ç¾æœ‰å­˜æ¬¾ç´¯ç©</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" v-model.number="config.moatTarget" class="input-underline border-orange-200 text-orange-700 font-black">
                        <input type="number" v-model.number="config.currentSavings" class="input-underline border-orange-200 text-orange-700 font-black">
                    </div>
                </div>
            </section>

            <!-- STEP 2: å›ºå®šæ”¯å‡º -->
            <section class="gray-card space-y-6">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Step 2. å›ºå®šå¿…è¦æ”¯å‡º (æœˆæ‰£é …ç›®)</p>
                <div class="grid grid-cols-2 gap-x-8 gap-y-6">
                    <div v-for="(val, key) in config.fixed" :key="key">
                        <label class="text-[10px] font-black text-gray-400 uppercase block mb-1">{{ fixedLabel(key) }}</label>
                        <div class="flex items-center gap-1 border-b-2 border-gray-200">
                            <span class="text-[8px] font-black text-gray-300 italic">NT$</span>
                            <input type="number" v-model.number="config.fixed[key]" class="w-full py-1.5 text-right font-black text-sm bg-transparent outline-none">
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 3: å‚µå‹™ç›£æ¸¬ -->
            <section class="step-card bg-rose-50/30 border-rose-100">
                <p class="text-[10px] font-black text-rose-500 mb-6 uppercase tracking-widest">Step 3. å‚µå‹™æ­¢è¡€ç›£æ¸¬ (é«˜åˆ©è²¸å„ªå…ˆ)</p>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <input v-model="newDebt.name" placeholder="åç¨±" class="input-underline text-xs">
                    <input type="number" v-model.number="newDebt.principal" placeholder="æœ¬é‡‘" class="input-underline text-xs">
                    <input type="number" v-model.number="newDebt.rate" placeholder="åˆ©ç‡ %" class="input-underline text-xs">
                    <input type="number" v-model.number="newDebt.monthly" placeholder="æœˆç¹³é¡" class="input-underline text-xs">
                </div>
                <button @click="addDebt" class="w-full bg-rose-500 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all">æ–°å¢è² å‚µé …ç›®</button>

                <div v-for="(debt, idx) in config.debts" :key="idx" class="mt-4 flex justify-between items-center p-4 bg-white rounded-2xl border border-rose-50">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-black text-gray-600">{{ debt.name }}</span>
                        <span class="text-[8px] font-bold" :class="debt.rate > 7 ? 'text-rose-600' : 'text-gray-400'">{{ debt.rate }}% {{ debt.rate > 7 ? 'âš ï¸ é«˜åˆ©è­¦å ±' : 'ğŸŸ¢ ä½åˆ©ç’°å¢ƒ' }}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-rose-500 text-sm">-$ {{ formatCurrency(debt.monthly) }}</span>
                        <button @click="config.debts.splice(idx, 1)" class="text-gray-200 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </section>

            <!-- STEP 4: é ç®—åˆ†è£ -->
            <section>
                <div class="flex justify-between items-center mb-6">
                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Step 4. é ç®—åˆ†è£èˆ‡å‹•æ…‹ç·¨è¼¯</p>
                    <span :class="remainingBalance < 0 ? 'text-rose-600' : 'text-emerald-500'" class="font-black text-[10px]">å‰©é¤˜å¾…åˆ†ï¼šNT$ {{ formatCurrency(remainingBalance) }}</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="env in envelopes" :key="env.id" :class="env.type === 'green' ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-blue-50 border-blue-100 text-blue-700'" class="p-4 rounded-[24px] border transition-all">
                        <label class="text-[8px] font-black uppercase opacity-60 mb-1 block">{{ env.name }}</label>
                        <input type="number" v-model.number="env.budget" class="w-full bg-transparent border-b-2 border-black/5 font-black text-lg outline-none">
                    </div>
                </div>
            </section>

            <button @click="currentTab = 'dashboard'" class="btn-sync shadow-2xl">åŒæ­¥æŒ‡ä»¤ä¸¦å•Ÿå‹•æˆ°æƒ…å ±å‘Š</button>
        </div>

        <!-- DASHBOARD: æˆ°å ±åˆ†æ -->
        <div v-if="currentTab === 'dashboard'" class="animate-in slide-in-from-right duration-500 space-y-8">
            <div class="flex justify-between items-end">
                <h2 class="text-3xl font-black tracking-tighter">æˆ°æƒ…å ±å‘Š</h2>
                <div class="text-right">
                    <p class="text-[9px] font-black text-gray-400 uppercase">ç”Ÿå‘½å·¥æ™‚</p>
                    <p class="font-black text-xl">${{ lifeHourlyRate.toFixed(1) }} <span class="text-[10px] font-normal opacity-40">/ hr</span></p>
                </div>
            </div>

            <!-- å¡è²»éš”é›¢è¢‹èˆ‡å¾…æ”¶å›è¢‹ -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-indigo-600 p-6 rounded-[32px] text-white shadow-xl relative overflow-hidden">
                    <div class="flex justify-between mb-2 opacity-50"><i data-lucide="credit-card" class="w-4 h-4"></i> <span class="text-[8px] font-black uppercase tracking-tighter">å¡è²»éš”é›¢</span></div>
                    <h3 class="text-2xl font-black">${{ formatCurrency(config.cardHolding) }}</h3>
                    <p class="text-[8px] opacity-60 mt-1">æ­¤é‡‘é¡å·²å¾ä¿¡å°ç§»å‡º</p>
                </div>
                <div class="bg-emerald-600 p-6 rounded-[32px] text-white shadow-xl relative overflow-hidden">
                    <div class="flex justify-between mb-2 opacity-50"><i data-lucide="users" class="w-4 h-4"></i> <span class="text-[8px] font-black uppercase tracking-tighter">å¾…æ”¶å›æ¬¾</span></div>
                    <h3 class="text-2xl font-black">${{ formatCurrency(config.pendingRefund) }}</h3>
                    <button v-if="config.pendingRefund > 0" @click="collectRefund" class="absolute bottom-2 right-4 bg-white/20 hover:bg-white/40 p-1.5 rounded-full transition-all">
                        <i data-lucide="corner-left-up" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            </div>

            <!-- ç´¯ç©è³‡ç”¢å¸³æœ¬ -->
            <div class="step-card bg-gray-900 text-white shadow-2xl relative overflow-hidden">
                <p class="text-[10px] font-black opacity-50 uppercase tracking-widest mb-2">ç¾æœ‰å­˜æ¬¾ç´¯ç© (è­·åŸæ²³æ°´ä½)</p>
                <h3 class="text-4xl font-black mb-6">$ {{ formatCurrency(config.currentSavings) }}</h3>
                <div class="w-full bg-white/10 h-2.5 rounded-full overflow-hidden mb-2">
                    <div class="bg-emerald-400 h-full rounded-full transition-all duration-1000" :style="{width: Math.min((config.currentSavings/config.moatTarget)*100, 100) + '%'}"></div>
                </div>
                <div class="flex justify-between text-[9px] font-black opacity-40 uppercase tracking-tighter">
                    <span>é€²åº¦ï¼š{{ Math.round((config.currentSavings/config.moatTarget)*100) }}%</span>
                    <span>ç›®æ¨™ï¼š$ {{ formatCurrency(config.moatTarget) }}</span>
                </div>
                <i data-lucide="shield-check" class="absolute -right-6 -bottom-6 w-32 h-32 opacity-10"></i>
            </div>

            <!-- å³æ™‚é€²åº¦æ¢ -->
            <div class="space-y-4">
                <h4 class="font-black text-gray-400 text-[10px] uppercase tracking-widest">ä¿¡å°é ç®—åŸ·è¡Œæ°´ä½</h4>
                <div v-for="env in envelopes" :key="env.id" class="step-card border-none bg-gray-50 p-5 space-y-3 shadow-sm">
                    <div class="flex justify-between text-[11px] font-black">
                        <span class="text-gray-800">{{ env.name }}</span>
                        <span :class="env.spent > env.budget ? 'text-rose-500' : 'text-gray-400'" class="font-mono tracking-tighter">
                            å·²è€— {{ Math.round((env.spent/env.budget)*100) }}% | å‰© ${{ formatCurrency(env.budget - env.spent) }}
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                        <div :class="env.spent > env.budget ? 'bg-rose-500' : 'bg-blue-600'" class="h-full transition-all duration-1000" :style="{width: Math.min((env.spent/env.budget)*100, 100) + '%'}"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXECUTION: æ‰£æ¬¾åŸ·è¡Œ -->
        <div v-if="currentTab === 'execution'" class="animate-in fade-in duration-500 space-y-8">
            <h2 class="text-2xl font-black">æ¯æ—¥æ‰£æ¬¾è¨˜å¸³</h2>
            
            <div class="bg-white p-8 rounded-[40px] border-2 border-gray-900 shadow-2xl space-y-8">
                <div class="space-y-2">
                    <div class="flex justify-between items-end">
                        <label class="text-[10px] font-black text-gray-400 uppercase">æœ¬æ¬¡ç¸½é–‹éŠ·</label>
                        <span v-if="selectedEnv" class="text-[10px] font-black text-blue-600">è¢‹å­å‰©ï¼š${{ formatCurrency(selectedEnv.budget - selectedEnv.spent) }}</span>
                    </div>
                    <input type="number" v-model.number="newTx.amount" class="w-full border-b-4 border-gray-100 py-3 font-black text-5xl focus:border-gray-900 outline-none transition-all" placeholder="0">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase block mb-1">æ‰£æ¬¾ä¾†æº</label>
                        <select v-model="newTx.envId" class="w-full bg-gray-50 p-3.5 rounded-2xl font-bold text-sm outline-none border border-gray-100">
                            <option v-for="env in envelopes" :value="env.id">{{ env.name }}</option>
                            <option value="misc">é›œæ”¯/é¤˜é¡è¢‹</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase block mb-1">æ”¯ä»˜å·¥å…·</label>
                        <div class="flex bg-gray-100 p-1.5 rounded-2xl gap-1 h-[52px]">
                            <button @click="newTx.method = 'cash'" :class="newTx.method === 'cash' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400'" class="toggle-btn">ç¾é‡‘</button>
                            <button @click="newTx.method = 'card'" :class="newTx.method === 'card' ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400'" class="toggle-btn">ä¿¡ç”¨å¡</button>
                        </div>
                    </div>
                </div>

                <!-- åˆ†å¸³ä»£å¢Š -->
                <div class="pt-6 border-t border-gray-100 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-[10px] font-black text-gray-800">å¹«æœ‹å‹å¢ŠéŒ¢äº†å—ï¼Ÿ</span>
                        </div>
                        <div @click="newTx.isSplit = !newTx.isSplit" :class="newTx.isSplit ? 'bg-emerald-500' : 'bg-gray-200'" class="w-12 h-6 rounded-full relative transition-all cursor-pointer">
                            <div :class="newTx.isSplit ? 'translate-x-6' : 'translate-x-1'" class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"></div>
                        </div>
                    </div>
                    <div v-if="newTx.isSplit" class="animate-in slide-in-from-top-2">
                        <label class="text-[9px] font-black text-emerald-600 uppercase mb-1 block">ä»£å¢Šé‡‘é¡ (å¾…æ”¶å›)</label>
                        <input type="number" v-model.number="newTx.splitAmount" class="input-underline border-emerald-100 text-emerald-700 font-bold bg-transparent" placeholder="è¼¸å…¥ä»£å¢Šéƒ¨åˆ†">
                    </div>
                </div>

                <button @click="recordTransaction" class="w-full bg-gray-900 text-white py-5 rounded-[40px] font-black text-lg active:scale-95 shadow-xl transition-all">ç¢ºå®šæ‰£æ¬¾ (è¢‹å­æ¸›å°‘)</button>
            </div>

            <!-- æœ€è¿‘ç´€éŒ„ -->
            <div class="space-y-4">
                <h4 class="font-black text-gray-400 text-[10px] uppercase flex items-center gap-2"><i data-lucide="history" class="w-3 h-3"></i> æœ€è¿‘ç´€éŒ„</h4>
                <div v-for="tx in transactions.slice().reverse().slice(0, 5)" :key="tx.id" class="flex justify-between items-center p-4 border-b border-gray-50">
                    <div class="flex items-center gap-4">
                        <div :class="tx.method === 'card' ? 'bg-indigo-50 text-indigo-600' : 'bg-gray-100 text-gray-500'" class="w-10 h-10 rounded-full flex items-center justify-center">
                            <i :data-lucide="tx.method === 'card' ? 'credit-card' : 'banknote'" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="font-black text-sm">{{ getEnvName(tx.envId) }}</p>
                            <p class="text-[9px] font-bold text-gray-400">{{ tx.date }} {{ tx.isSplit ? 'Â· ä»£å¢Šéš”é›¢' : '' }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-gray-900">-$ {{ formatCurrency(tx.amount) }}</p>
                        <p v-if="tx.isSplit" class="text-[8px] font-bold text-emerald-500">å¾…æ”¶ï¼š$ {{ formatCurrency(tx.splitAmount) }}</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around p-3 pb-8 z-50">
        <button v-for="t in menuTabs" :key="t.id" @click="currentTab = t.id" :class="currentTab === t.id ? 'text-gray-900 scale-110' : 'text-gray-300'" class="flex flex-col items-center gap-1 transition-all">
            <i :data-lucide="t.icon" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter">{{ t.name }}</span>
        </button>
    </footer>

</div>

<script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        const currentTab = ref('setup');
        const message = ref("");
        
        const tabs = [{id: 'setup', name: 'æˆ°ç•¥æŒ‡ä»¤'}, {id: 'dashboard', name: 'æˆ°å ±åˆ†æ'}, {id: 'execution', name: 'æ‰£æ¬¾åŸ·è¡Œ'}];
        const menuTabs = [
            { id: 'dashboard', name: 'Dashboard', icon: 'layout-dashboard' },
            { id: 'setup', name: 'Wizard', icon: 'settings' },
            { id: 'execution', name: 'Log', icon: 'wallet' }
        ];

        // --- æ ¸å¿ƒè³‡ç”¢ç‹€æ…‹ ---
        const config = ref({
            salary: 55000,
            bonus: 0,
            moatTarget: 300000,
            currentSavings: 120000, // æœƒéš¨æœˆä»½ç´¯ç©
            cardHolding: 0,      // ä¿¡ç”¨å¡å¾…ç¹³éš”é›¢å€
            pendingRefund: 0,    // ä»£å¢Šå¾…æ”¶å›
            fixed: {
                debt: 3500,
                rent: 12000,
                telecom: 699,
                utility: 1500,
                other: 0
            },
            debts: [
                { name: 'æ‰‹æ©Ÿåˆ†æœŸ', principal: 10000, rate: 0, monthly: 500 }
            ],
            goals: { flower: 400, travelBudget: 50000, travelDays: 5 },
            longTerm: { tax: 12000, insurance: 20000, travel: 100000, buffer: 50000, shopping: 10000, social: 10000, wish: 30000, dirt: 5000 }
        });

        const envelopes = ref([
            { id: 'env_1', name: 'å®šæœŸå®šé¡æŠ•', budget: 0, spent: 0, type: 'green' },
            { id: 'env_2', name: 'æ¯æœˆæ’¥å…¥é å­˜', budget: 0, spent: 0, type: 'green' },
            { id: 'env_3', name: 'é€±é¤è²»è¨­å®š', budget: 0, spent: 0, type: 'blue' },
            { id: 'env_4', name: 'é›œæ”¯/é¤˜é¡è¢‹', budget: 0, spent: 0, type: 'blue' },
            { id: 'env_5', name: 'äº¤é€šåŠ æ²¹åŒ…', budget: 0, spent: 0, type: 'blue' },
            { id: 'env_6', name: 'æ—¥ç”¨å®¶äº‹åŒ…', budget: 0, spent: 0, type: 'blue' }
        ]);

        const transactions = ref([]);
        const newDebt = ref({ name: '', principal: 0, rate: 0, monthly: 0 });
        const newTx = ref({ amount: 0, envId: 'env_3', method: 'cash', isSplit: false, splitAmount: 0 });

        // --- è¨ˆç®—é‚è¼¯ ---
        const totalEnergy = computed(() => (config.value.salary || 0) + (config.value.bonus || 0));
        const lifeHourlyRate = computed(() => totalEnergy.value / 160);
        
        const strategyLevel = computed(() => {
            return config.value.debts.some(d => d.rate > 7) ? 1 : 2;
        });

        const totalFixedAndDebt = computed(() => {
            const fixedSum = Object.values(config.value.fixed).reduce((a, b) => a + (Number(b) || 0), 0);
            const debtSum = config.value.debts.reduce((a, b) => a + (Number(b.monthly) || 0), 0);
            return fixedSum + debtSum;
        });

        const remainingBalance = computed(() => {
            const envSum = envelopes.value.reduce((a, b) => a + (Number(b.budget) || 0), 0);
            return totalEnergy.value - totalFixedAndDebt.value - envSum;
        });

        const selectedEnv = computed(() => envelopes.value.find(e => e.id === newTx.value.envId));

        // --- æ–¹æ³• ---
        const formatCurrency = (val) => new Intl.NumberFormat('zh-TW').format(val || 0);
        const fixedLabel = (k) => ({ debt: 'å­¸è²¸/åˆ†æœŸ', rent: 'æˆ¿ç§Ÿ/æˆ¿è²¸', telecom: 'é›»ä¿¡/ç¶²è·¯', utility: 'æ°´é›»ç“¦æ–¯', other: 'è‡ªè¨‚å…¶ä»–' }[k]);
        
        const showMsg = (txt) => {
            message.value = txt;
            setTimeout(() => message.value = "", 3000);
        };

        // ã€é è¨­æˆ°è¡“åˆ†é…ã€‘ï¼š532 åŸå‰‡
        const applyDefaultAllocation = () => {
            const disposable = totalEnergy.value - totalFixedAndDebt.value;
            if(disposable <= 0) {
                showMsg("èƒ½é‡ä¸è¶³ä»¥é€²è¡Œæˆ°è¡“åˆ†é…ï¼");
                return;
            }

            // åˆ†é…é‚è¼¯ï¼š
            // æŠ•è³‡è¢‹ (env_1) 30%
            // é å­˜è¢‹ (env_2) 20%
            // ç”Ÿæ´»è¢‹ (env_3~6) åˆè¨ˆ 50%
            const pInvest = Math.floor(disposable * 0.3);
            const pPreSave = Math.floor(disposable * 0.2);
            const pLivingBase = Math.floor(disposable * 0.5);

            envelopes.value.forEach(env => {
                if(env.id === 'env_1') env.budget = pInvest;
                if(env.id === 'env_2') env.budget = pPreSave;
                if(env.id === 'env_3') env.budget = Math.floor(pLivingBase * 0.4); // é€±é¤è²»ä½”ç”Ÿæ´» 40%
                if(env.id === 'env_4') env.budget = Math.floor(pLivingBase * 0.3); // é›œæ”¯ 30%
                if(env.id === 'env_5') env.budget = Math.floor(pLivingBase * 0.15); // äº¤é€š 15%
                if(env.id === 'env_6') env.budget = Math.floor(pLivingBase * 0.15); // å®¶äº‹ 15%
            });

            showMsg("æˆ°è¡“æŒ‡ä»¤ï¼šé ç®—å·²è‡ªå‹•æŒ‡æ´¾ä»»å‹™ã€‚");
        };

        const addDebt = () => {
            if(!newDebt.value.name) return;
            config.value.debts.push({...newDebt.value});
            newDebt.value = { name: '', principal: 0, rate: 0, monthly: 0 };
            nextTick(() => lucide.createIcons());
        };

        const recordTransaction = () => {
            if(newTx.value.amount <= 0) return;
            const env = envelopes.value.find(e => e.id === newTx.value.envId);
            const myActualPart = newTx.value.isSplit ? (newTx.value.amount - newTx.value.splitAmount) : newTx.value.amount;

            // æ‰£é™¤è¢‹å­æ°´ä½ (è¢‹å­æ‹¿èµ°äº†ç¸½é‡‘é¡)
            if(env) env.spent += newTx.value.amount;

            // ä¿¡ç”¨å¡éš”é›¢
            if(newTx.method === 'card') {
                config.value.cardHolding += myActualPart;
            }

            // ä»£å¢Šæ¬¾éš”é›¢
            if(newTx.value.isSplit) {
                config.value.pendingRefund += newTx.value.splitAmount;
            }

            transactions.value.push({ id: Date.now(), date: new Date().toLocaleDateString('zh-TW'), ...newTx.value });
            newTx.value = { amount: 0, envId: 'env_3', method: 'cash', isSplit: false, splitAmount: 0 };
            showMsg("åŒæ­¥æˆåŠŸï¼");
        };

        const collectRefund = () => {
            const amount = config.value.pendingRefund;
            config.value.currentSavings += amount;
            config.value.pendingRefund = 0;
            showMsg(`æ”¶å›ä»£å¢Š $${formatCurrency(amount)} å·²ç´¯ç©è‡³è­·åŸæ²³ã€‚`);
        };

        // æœˆåº¦çµè½‰ï¼šè®“è³‡ç”¢çœŸæ­£æœƒã€Œç´¯ç©ã€
        const confirmRollover = () => {
            if(!confirm("å•Ÿå‹•çµè½‰æŒ‡ä»¤ï¼Ÿé€™å°‡æ¸…ç©ºæœˆæ”¯å‡ºæ°´ä½ï¼Œä¸¦å°‡ã€æ²’èŠ±å®Œçš„éŒ¢ã€èˆ‡ã€çµé¤˜ã€è‡ªå‹•æ»¾å…¥å­˜æ¬¾ç´¯ç©ã€‚")) return;
            
            let monthSaved = 0;
            envelopes.value.forEach(env => {
                monthSaved += (env.budget - env.spent);
                env.spent = 0;
            });
            monthSaved += Math.max(0, remainingBalance.value);
            
            config.value.currentSavings += monthSaved;
            config.value.cardHolding = 0;
            transactions.value = [];
            
            showMsg(`çµè½‰æˆåŠŸï¼æœ¬æœˆå­˜ä¸‹ $${formatCurrency(monthSaved)}ã€‚`);
        };

        const exportCSV = () => {
            let csv = "Date,Amount,Envelope,Method,Note\n";
            transactions.value.forEach(t => {
                csv += `${t.date},${t.amount},${getEnvName(t.envId)},${t.method},${t.isSplit ? 'Split' : ''}\n`;
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `FINANCE_CMD_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        };

        const getEnvName = (id) => envelopes.value.find(e => e.id === id)?.name || 'é›œæ”¯è¢‹';

        onMounted(() => { 
            lucide.createIcons();
            // åˆå§‹åŒ–åˆ†é…
            applyDefaultAllocation();
        });
        watch(currentTab, () => nextTick(() => lucide.createIcons()));

        return {
            currentTab, tabs, menuTabs, config, envelopes, transactions, newDebt, newTx, message,
            totalEnergy, lifeHourlyRate, strategyLevel, remainingBalance, selectedEnv,
            formatCurrency, fixedLabel, addDebt, recordTransaction, collectRefund, confirmRollover, exportCSV, getEnvName, applyDefaultAllocation
        };
    }
}).mount('#app');
</script>
</body>
</html>